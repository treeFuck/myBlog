# 模拟面试题

## 三、前沿知识
### 6.1 什么是微前端

当前，单页面应用是一种比较主流的前端项目形态，但是单页面应用往往随着功能的拓展和开发人员的增大，变得越来越难以维护，往往该一处而动全身。也就是所谓的“巨石应用”。

为此，提出了微前端这个架构理念，也就是将一个前端应用拆分成多个细粒度更低的微应用，微应用可以独立开发、测试、部署的微应用，且互不影响。

微前端，具有四个核心价值：

1. 技术栈无关。不同的微应用可以使用不同的技术栈
2. 独立开发、测试、部署。每一个微应用都是独立且成熟的产品，可以进行独立的开发、测试、部署。
3. 增量式升级。微应用之间相互独立，所以我们可以选择逐个微应用的进行升级，实现主应用的渐进式升级。
4. 独立运行时。没有微应用之间状态隔离，运行时状态不共享。

### 6.2 qiankun 的设计原理

qiankun 的设计原理，可以分为三大点：

1. 微应用之间的切换
2. 隔离
3. 通信

第一点，微应用之间的切换。qiankun 采取的是路由分发策略，将不同的路由和不同的微应用绑定起来，一旦 url 发送变化，就触发路由匹配，渲染对应路由的微应用。关键的切换函数是内部的一个 loadApp  方法。

第二点，就是隔离，分为 js 隔离和 css 隔离。
css 隔离的话，是给微应用的 DOM 外部套一个 shadow DOM，利用 shadow DOM 的隔离性来实现 css 隔离。
js 隔离的话，是通过创建 js 沙箱，限制 js 对 window 的访问的和修改。js 沙箱分三类：

1. 快照沙箱，不支持 Proxy 的浏览器的兼容版本。本质是用两个对象记录上微应用加载前和卸载前的 window，用来还原 window → 前者是还原主应用 window，后者是还原微应用 window。这个隔离方式比较简单，如果同时运行多个微应用，可能会出错。
2. 用 proxy 去拦截到微应用 js 脚本对 window 的访问，以此来维护三个状态池，也是和快照沙箱类似，本质记录微应用加载前和卸载前的状态，最后去还原 window。这个隔离方式也不适合同时运行多个微应用。
3. 也使用了 proxy 去拦截微应用 js 脚本对 window 的访问，不同的是，它将对 window 的操作都引向另一个对象，这个对象是 window 的一个复制，所以不会影响到 window 本身。这种隔离方式比较合理，可以同时运行多个微应用。


第三点就是，微应用之间的通信。
微应用之间应该尽量减少通信，以降低耦合性。但有的时候需要必要的通信。

qiankun 提供一种叫 action 通信的机制让微应用之间可以通信。这个通信机制采取的观察者模式。

它在全局维护了一个 globalState 对象，然后微应用或主应用可以注册观察者，观察者会统一放到一个观察者池里面去。当有微应用或主应用可以去修改 globalState，进而触发观察者池里全部的观察者。

### 6.3 为什么微前端不使用 iframe

iframe 是天生完美隔离的容器，但它最大的缺点也就是它的隔离性很难甚至无法突破：

1. iframe 的通信问题。iframe 之间只能通过 postMessage  或自己的 window 对象来进行通信，比较局限不够灵活。
2. iframe 的样式问题。比如我在 iframe 里想弹出一个全局的遮罩，但是因为 iframe，所以这个遮罩只会盖住 iframe 本身。
3. iframe 的性能问题。onload 事件必须等待全部 iframe 加载完毕才能触发，影响主页加载。
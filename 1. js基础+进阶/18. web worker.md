# web worker

## 一、简介
web worker 是 HTML5 的一个标准，允许一段 js 程序允许在主线程之外的另一个线程。

web worker 分两类：
- 专用线程 Dedicated Worker → 只被一个页面所使用 → `new Worker(url)`
- 共享线程 Shared Worker → 可以被多个页面所共享 → `new SharedWorker(url)`

## 二、通信
```js
// worker.js
self.onmessage = (e)=> {
	console.log(e.data); // {b: 1}
	self.postMessage({a: 1})
}


// main.js
let worker = new Worker('worker.js');
worker.onmessage = (e)=> {
	console.log(e.data); // {a:1}
}
worker.postMessage({b: 1});
```

所以就是，利用 postMessage 传递数据，然后监听 message 事件来获取数据。

postMessage 传递的数据的默认是值的拷贝，也可以将数据的上下文转移到另一个线程。关键点在于它的参数：
- aMessage：传递数据，可以是基本类型也可以是引用类型
- transferList ：一个数组，里面的元素会被转移所有权，但是只能是 ArrayBuffer，MessagePort 或 ImageBitmap 的实例对象

## 三、worker 上下文
worker 线程的最顶层不是 window，而是一个叫 WorkerGlobalScope 的东东，所以无法访问 BOM、DOM 等，但可以使用 setTimeout、setInterval 定时器

WorkerGlobalScope 作用域下的常用属性和方法：
- self：worker 实例对象
- location： worker 被创建出来的时候与之关联的 WorkerLocation 对象
- close：关闭当前线程
- importSrcipt：用来通过 url 加载库函数
- XMLHttpRequest：用来发起 http 请求
- setTimeout / setInterval：定时器
- addEventListener：用来监听事件


## 四、示例
web Worker 子线程 js 
```js
// 顶层对象 self
console.log(self); 
// message 事件回调，用来接收主线程传递过来的数据
self.onmessage = (e) => console.log('主线程 → worker', e.data)
// postMessage 方法，用来向主线程发送数据
self.postMessage({a: 99})
// 关闭该 Worker 线程
self.close(); 
```

主线程 js
```js
// 主线程 js
var myWorker = new Worker('worker.js');

// 向 worker 线程发送数据
myWorker.postMessage({a: 1})
// 指定 message 事件回调
myWorker.onmessage = (e) => console.log('worker → 主线程', e.data);
// 指定 error 事件回调
myWorker.onerror = (e) => {}
// 指定 messageerror 事件回调
myWorker.onmessageerror = (e) => {}
// 立即终止 worker 线程
myWorker.terminate()
```
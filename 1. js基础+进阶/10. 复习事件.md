# 事件
## 一、事件流
DOM2 级事件规定的事件流包括三个阶段：
1. 事件捕获阶段
2. 处于目标阶段
3. 事件冒泡阶段

## 二、 事件处理程序
响应某个事件的函数，就叫**事件处理程序(或事件侦听器)**。
### 1. DOM0 级事件处理程序
```js
btn.onclick = function(){}; // 添加
btn.onclick = null; // 移除
```
### 2. DOM2 级事件处理程序
```js
let fun = ()=>{};
btn.addEventListener('click', fun); // 添加
btn.removeEventListener('click', fun); // 移除
```
上诉两个方法都接受三个参数：
1. 要处理的事件名
2. 作为事件处理程序的函数
3. **一个布尔值，为 true 时表示捕获，为 false 时表示冒泡。可选，默认为 false**

> 注意：因为用 removeEventListener 移除事件处理程序必须拿到函数指针，所以**用 addEventListener 添加的匿名函数将无法被移除**

拓展：用 DOM2 事件模拟DOM0 事件
```js
Element.prototype.myOn = function(type, fun) {
	this.removeEventListener(type, this['_on'+type]);
	// 自定义元素节点内部变量 this['_on'+type] 保存当前的事件函数引用，方便移除
	this['_on'+type] = fun;
	let res = this.addEventListener(type, fun);
	return res;
}
```
#### 1. this
this 正常会指向事件绑定元素。

但如果事件处理程序是一个箭头函数，那么 this 的指向就会很迷了。
#### 2. event 对象
可以通过事件处理程序函数的第一个参数来获取。event 对象只在程序执行期间存在，程序执行完毕后没有指针引用，会被销毁。

**常用属性：**

1. event.currentTarget：事件处理程序当前正在处理的元素
2. event.target：事件的实际目标
3. eventPhase：表示事件流处于哪个阶段
	- 1 → 捕获
	- 2 → 目标对象
	- 3 → 冒泡

**常用方法：**

1. event.preventDefault()：阻止特定事件的默认行为
2. event.stopPropagation()：阻止事件的捕获或冒泡（如果有父元素在事件捕获阶段阻止了事件捕获，那么目标元素就会一直无法触发事件）

## 三、事件类型
DOM3 规定了以下事件：
### 1. UI 事件
- readystatechange：页面加载的 readyState 改变时触发
- DOMContentLoaded：html 文件加载解析成 DOM 树后，在 document / window 触发 
- load：页面加载完毕后，在 window 触发
- unload：页面完全卸载后，在 window 触发
- resize：窗口大小变化时，在 window 触发
- scroll：用户滚动带滚动条的元素时，在该元素上触发
###  2. 焦点事件
- blur：元素失去焦点时触发。这个事件**不会冒泡**
- focus：元素得到焦点时触发。这个事件**不会冒泡**
- **focusout**：元素失去焦点时触发。这个事件**会冒泡**
- **focusin**：元素得到焦点时触发。这个事件**会冒泡**
### 3. 鼠标事件
- click：单击鼠标触发
- dblclick：双击鼠标触发
- mousedown：按下鼠标触发
- mouseup：抬起鼠标触发
- mousemove：在元素内部移动时重复地触发
- **mouseenter**：鼠标进入目标元素触发，**不能冒泡**，所以鼠标进入子元素时**不会触发**目标元素的该事件
- **mouseleave**：鼠标离开目标元素触发，**不能冒泡**，所以鼠标离开子元素时**不会触发**目标元素的该事件
- **mouseover**：鼠标进入目标元素触发，**可以冒泡**，所以鼠标进入子元素**会触发**目标元素的该事件
- **mouseout**：鼠标离开目标元素触发，**可以冒泡**，所以鼠标离开子元素**会触发**目标元素的该事件

>  **注意：**只有在同一个元素相继触发 mousedown 和 mouseup 事件，才能触发 click 事件，拖拽鼠标离开原本元素不会触发 click 事件。还有，双击间隔太慢也不会触发 dblclick 事件。

mousedown、mouseup、click、dblclick 的触发顺序如下：
1. mousedown
2. mouseup
3. click
4. mousedown
5. mouseup
6. click
7. dblclick

### 4. 滚轮事件
**1. mousewheel 事件**

1. 鼠标在目标元素上滚动鼠标滚轮时，在目标元素上触发，可以冒泡
2. 上拉页面向前滚动鼠标时，event.wheelDelta 是正数（chrome 是 150）
3. 下拉页面向后滚动鼠标时，event.wheelDelta 是负数（chrome 是 -150）
> ps：Opera 9.5之前，正负和上述的是颠倒的。

**2. scroll 事件**

1. 元素滚动条滚动时触发，可以冒泡
2. 通过判断滚动元素的 scrollTop 来判断滚动条当前位置

### 5. 键盘事件
1. keydown：按下键盘任意键触发，按住不放会一直触发
2. keypress：按下键盘字符键触发，按住不放会一直触发
3. keyup：松开键盘触发

## 四、内存与性能
### 1. 事件委托
将事件委托到公共父元素上，减少事件处理程序数量，提升页面性能。

### 2. 移除事件处理程序
在元素节点不需要事件处理程序时，要把事件处理程序从元素节点移除。

比如 removeChild() 和 replaceChild() 移除节点的时候，或者是修改元素的 innerHTML、outerHTML 的时候，**原来添加到元素中的事件处理程序极有可能无法被当作垃圾回收**。

## 五、模拟事件
### 1. 创建事件
**调用 document.createEvent(事件类型) 方法可以创建一个 event 对象**。

DOM3 里，参数里的事件类型字符串可以是下面几种：
1. **UIEvent**：一般化的 UI 事件
2. **MouseEvent**：一般化的鼠标事件
3. **MutationEvent**：一般化的 DOM 变动事件
4. **CustomEvent**：自定义事件

**创建事件完毕后，需要调用 event 对象的初始化方法初始化 event**，比如 MouseEvent 类型的 event 初始化方法为 event.initMouseEvent()，该方法的每个参数都用来初始化 event，前四种比较重要分别是：

1. type：事件类型，比如 'click'
2. bubbles：布尔值，是否冒泡
3. cancelable：布尔值，事件是否可以取消
4. view：与事件关联的视图，这个参数几乎总是要设置为document.defaultView。 

### 2. 触发事件
**在元素节点上调用 dispatchEvent(event) 方法触发 event 。**

```js
let btn = a;
btn.onclick = ()=>{console.log('111')};

let event = document.createEvent('MouseEvent');
event.initMouseEvent('click');
btn.dispatchEvent(event) 
```
### 3. 自定义事件
DOM3 还添加了自定义事件，让开发者创建自己的事件。**创建自定义事件可以调用 createEvent("CustomEvent")，返回的 event 对象还需要调用 event.initCustomEvent() 进行初始化**，接收如下4个参数：
1. type：字符串，事件类型
2. bubbles：布尔值，是否冒泡
3. cancelable：布尔值，是否可以取消
4. detail：对象，保存在 event 对象的 detail 属性中

```js
a.addEventListener('xiuer', ()=>{
	console.log('aaasa')
})

let event = document.createEvent('CustomEvent');
event.initCustomEvent('xiuer');
a.dispatchEvent(event);
```
> **注意：给元素节点绑定自定义事件的事件处理程序时，只能用 DOM2 的 addEventListener，不能用 DOM0 的 onxxx**

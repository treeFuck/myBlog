# 构建民航业知识图谱并实现语义查询

「描述」对2011-2018年民航行业发展公报里的海量数据进行建模分析，并构建对应实体关系，将实体关系以动态知识图谱的形式可视化出来。

「成就」获得第九届“中国软件杯”全国一等奖

「职责」知识图谱 web 页面可视化

「项目亮点」封装了知识图谱svg的d3操作，并用 getter、setter 代理将其维护成一段响应式json数据，降低该项目的维护成本，减少其他小伙伴对 D3 的学习成本。

「技术要点」Vue、Svg、D3.js、


## 这个项目是一个人完成的吗？
不是，前端部分是


## 为什么能拿一等奖
第一点，肯定是我的队友给力，我的其他两个队友，负责数据挖掘的部分，对海量的数据进行建模分析，实现了这个软件的核心功能。

第二点，就是我做的 web 可视化还不错吧。因为我有对比过同赛题其他的作品，我发现大部分的知识图谱可视化部分，他们都选择调一些可视化的库，就是那种你把数据传递进去之后，然后渲染部分就交给了库去实现。这种方法，有一个缺点，就是很难实现一些交互，因为知识图谱上的点都是库去渲染的，你连 DOM 都接触不到，对上就是一个封闭的黑盒。

所以，而我选择了 d3js 和 svg 去绘制知识图谱。d3 和其他可视化库最大的差别就是，d3 更像一支笔，你要自己一点一点地去进行绘制，所以使用起来有一定的学习成本和复杂度，不过它很灵活，可以实现很多知识图谱的交互，比如我用 d3 去实现了一个功能：在一个图谱上一个点，就可以展示它的子图谱，再点，就收起。另外，这个功能我发现其他人是很少去实现的。

## proxy 代理

我设计 prxoy 代理的目的，其实很简单，就是为了把这个项目给继续维护下去。因为知识图谱方面的研究，算我们工作室以后数据挖掘组的一个研究方向，所以他们以后可能可以借助我的这个页面去做一些其他的研究或者比赛。所以，我就做了一些封装，把底层的 d3 操作都封装起来，通过 proxy 代理的方法，去维护成一段响应式数据，这段响应式数据，本身就是一个 josn 的树状结构，对应着一个自顶向下的知识图谱。可以后续可以简单对这段 json 数据进行修改，然后就触发 d3 操作去在页面上渲染新的知识图谱结构。

其实是一些简单的代理操作，主要是被 vue3.0 里面的 proxy 数据劫持启发到。

## 说一下你怎么使用的 web weoker 

就是，原本我们是计划做一个图表可视化的功能，正常来说就是我向后端请求数据，然后调图表库展示出来嘛。但，因为当时时间比较紧急，数据挖掘的两个人有其他的工作要做，没有时间去处理图表数据的计算这部分的工作。所以我就提议，把图表数据的计算这部分工作交给前端，他们把图表的原始数据给我就行。

但是，因为 js 是单线程嘛，而且在主线程里我需要用 d3 去操作很多 svg 的 dom 来实现知识图谱的可视化，所以，如果我还在 js 主线程去计算图表数据的话，可能导致图表的渲染不及时。

因此，我给每一个图表，都开了一个 web worker 去计算数据，一方面避免 js 主线程的阻塞，另一方面多个子线程的并行执行也优化计算速度。

## 优化了多少，有统计过吗？
这个原始数据，其实就是描述知识图谱的那个 json 数据。是一个比较大 json 对象，每一个图表的数据可能需要遍历它的某一个子树来计算得到，我采用的是层序遍历的方法去进行计算。

如果是没有用 web worker 的话，在页面初始化的时候，这个图表大约要 1 秒到 2 秒左右才能渲染出来，有明显的空白期。用了 web worker 之后，大约不到 500 毫秒，用户只能感受到短暂的空白。


## 说一下 d3.js 

我对 d3 其实不是特别了解，主要是因为打这场比赛需要用到，所以去学了一些简单语法，基本停留在只会调 api 的阶段。

不过用了之后，我有一个感受就是，d3 和其他图形库不同的就是，它像一支笔，让自己去天马行空的绘制，因为它封装了很多关于 svg 的 DOM 操作，可以对 svg 进行很多程度的自由设计。

而其他的图形库，比如 echart 图表，就是一个工具，把渲染的工作全部交给工具去实现，你只需要往里面传递数据就行。

## 对 api 进行统一处理，能说一说具体怎么处理吗？
说一下 axios 的拦截，比如最常见的就是登录 token 的拦截：
- 在请求做一个拦截，判断是否有 token，有的话就把 token 字段放上去
- 在响应做一个拦截，如果登录 token 过期了，就路由跳转到登录页面让用户登录。

这样做的好处，就是能够对项目里请求的公共的部分抽离出来，做一些统一的处理，方便其他开发者开发，也方便项目的后续维护。

```js
// 引入 axios
import axios from 'axios'  
// 创建 axios 实例
let instance = axios.create({
  headers: {
    'content-type': 'application/x-www-form-urlencoded'
  }
})
// 请求拦截
instance.interceptors.request.use(config => {
    const token = sessionStorage.getItem('token')
    if (token ) { 
    // 判断是否存在token，如果存在的话，则每个http header都加上token
      config.headers.authorization = token  
    }
    return config
})
// 响应拦截
instance.interceptors.response.use(response => {
    // 拦截响应，做统一处理 
    if (response.data.code === 1001) {
          router.replace({path: 'login'})
    }
    return response
})
```


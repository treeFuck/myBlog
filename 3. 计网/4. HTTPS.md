# HTTPS
## 一、HTTP 的缺点
1. 通信使用明文 → 内容可能被窃听
2. 不验证通信方的身份 → 第三方可以伪装成通信方
3. 不验证报文的完整性 → 报文可能被篡改

针对这些缺点，提出了 HTTPS → **HTTP + 加密 + 认证 + 完整性保护 = HTTPS**

## 二、HTTPS
### 2.1 概述
HTTP 的默认端口是 80，而 HTTPS 的默认端口是 443

HTTPS 本质是身披 SSL 外壳的 HTTP。在采用 SSL 后，HTTP就拥有了HTTPS的加密、证书和完整性保护这些功能。
### 2.2 加密

#### 1. 共享密钥加密（对称密钥加密）
通信双方持有一样的密钥，对通信内容进行加密和解密。

它的困境在于，在通信开始前，**拥有密钥的一方如何将密钥安全地转交给通信的另一方**。

#### 2. 公开密钥加密（非对称密钥加密）
公开密钥加密方式，采用两把密钥：公钥和私钥。**公钥可以随意发布，私钥只有自己拥有**。

在通信开始前，服务端将公钥发给客户端，然后客户端用公钥对通信内容进行加密，服务端收到加密内容后用私钥对其进行解密。

因为公钥可以随意发布，所以它解决了对称加密的困境。

但是，它也有自己的困境：**客户端无法判断收到的公钥的正确性**。



#### 4. HTTPS 的加密方式

HTTPS 采用对称密钥加密和公开密钥加密混合的加密机制。

1. 先使用公开密钥加密进行通信，客户端向服务端传递一把共享密钥。
2. 后续的通信，用刚刚传递的共享密钥来进行对称密钥加密通信。

### 2.3 认证
#### 3. 认证服务端
刚刚说过，公开密钥加密的缺点在于，无法判断服务端发送过来的公钥正确性，或者说是无法判断服务端的正确性。

为了证明客户端收到的公钥的正确性，可以委托权威第三方机构来进行认证。

服务端生成公钥密钥后，会让第三方机构给自己的公钥颁发证书。然后在发送公钥到客户端时，把证书也连同发送过去。

客户端收到公钥和其证书后，对证书进行验证，验证通过，则相信该公钥的正确性，也就相信了服务端的正确性。

> 第三方机构颁发公钥证书时，会用本机构的私钥对证书上的数字签名进行加密。
> 
> 而客户端，比如浏览器，会自带常用第三方认证机构的公钥，**这个公钥可以判断一份公钥证书的数字签名是否是用对应私钥加密的**，因此可以判断证书是否是其颁布的，进而判断了证书的合法性公钥的正确性。
> 
> 所以，客户端真正信任的不是拥有公钥的服务端，而是给公钥颁布证书的第三方机构，因为信任第三方机构，所以才相信服务端。

#### 4. 认证客户端
客户端也有客户端证书，作用跟服务端公钥证书如出一辙。

不过它存在两个问题：
1. 获取困难。客户端证书一般需要用户自行购买和安装。
2. 认证缺陷。客户端认证的不是客户本身，而是安装了证书的计算机。

### 2.4 完整性保护
应用层使用 HTTPS 时，发送数据时会附加一种叫 MAC 的报文摘要。MAC 能够判断一份报文是否遭到篡改，从而保证报文完整性。

HTTP 其实也有报文摘要机制 MD5，但是因为 HTTP 是明文传输，篡改报文摘要也不是难事。

但 HTTPS 有加密和认证机制，想要成功的篡改一份已经加密过的报文摘要是很困难的。

### 2.5 HTTPS 的缺点
1. 与 HTTP 相比，HTTPS 的通信速度更慢。（一是因为通信过程变复杂，二是因为消耗更多的资源）
2. 需要支付证书认证等高额费用。

### 2.6 建立 SSL 通信的四次握手
![](./HTTPS四次握手.jfif)

1. 第一次握手，客户端发起 SSL 通信请求。
2. 第二次握手，若服务端同意连接，则发送公钥和公钥证书给客户端。
3. 第三次握手，客户端认证公钥证书后，生成随机密码串（共享密钥），并用公钥加密后发送给服务端。
4. 第四次握手，服务端收到报文用密钥解密，得到随机密码串（共享密钥）。

第四次握手后，双方都拿到了共享密钥，后序的通信就用共享密钥进行通信。

